<div class="container">
      <br /><br /><br />
      <div class="col-lg-2 col-md-2 hidden-sm hidden-xs">
      </div>
      <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
          <div class="purchase_order_show col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <br />
            <div class="payment-errors">
            <h4><%= bootstrap_flash %></h4>
            </div>
            <br />
            <div class="merchant_form_headings">
      				<h2>Customer Details:</h2>
      			</div>
    				<h2><b><%= @order.cust_first_name%> <%= @order.cust_last_name%></h2>
    				<h5><%= @order.cust_email %></h5><br />
    				<h2><%= @order.street_address %></h2>
    				<h2><%= @order.city%>, <%= @order.prov_state %>, <%= @order.country%></h2>
    				<h2><%= @order.postal_zip%></h2><br />
            <%= link_to "Edit My Details", orders_customer_details_form_path(@order) %>
            <br /><br />
    			</div>
          <div class="merchant_order_products col-lg-12 col-md-12 col-sm-12 col-xs-12">
      			<div class="merchant_form_headings">
      				<h2>Selected Items:</h2>
      			</div>
      			<div class="purchase_order_show">
      				<% @order.order_units.where.not(quantity: 0).each do |f|%>
      				<div class="order_show_product">
                <%= image_tag(f.unit.product.photo.url(:thumb)) %><br />
      				<h5><%= f.unit.product.name %></h5>
      				<%=number_to_currency(f.unit.product.price, unit: '$') %><br />
      					<% if f.unit.size == "n/a" and f.unit.colour == "n/a" %>
      					Quantity: <%= f.quantity %><br />
      					<%elsif f.unit.size != "n/a" and f.unit.colour == "n/a" %>
      					<%= f.quantity %> X <%= f.unit.size %><br />
      					<%elsif f.unit.size != "n/a" and f.unit.colour != "n/a" %>
      					<%= f.quantity %> X <%= f.unit.size %>, <%= f.unit.colour %><br />
      					<%else%>
      					<%end%>
      				  <br />
      					Sold By: <%= f.unit.product.user.merchant_name %><br />
      					<% @order.merchant_orders.where(product_id: f.unit.product.id).each do |s| %>
      						<% if s.delivery_method == "Standard Shipping"%>
      							Delivery Method: <%= s.delivery_method%><br />
      							Shipping From: <%= f.unit.product.user.city %>, <%= f.unit.product.user.state_prov%>, <%= f.unit.product.user.country %><br /><br />
      						<%else%>
      							Delivery Method: <%= s.delivery_method%><br />
      							Pick Up Order From: <%= f.unit.product.user.merchant_name %> in <%= f.unit.product.user.city %>, <%= f.unit.product.user.state_prov%>, <%= f.unit.product.user.country %><br />
      						<%end%>
      							<%unless s.customer_comments.blank?%>
      							Customer Comments: <%= s.customer_comments %><br />
      							<%end%>
      					<%end%>
      				</div>
              <br />
      				<%end%>
              <%= link_to "Edit My Selection", cart_path(@order) %>
      			</div>
            <div class="merchant_form_headings">
      				<h2>Payment:</h2>
      			</div>
            <div class="left col-lg-6 col-md-6 col-sm-6 col-xs-6">
            Subtotal:
            </div>
            <div class="right col-lg-6 col-md-6 col-sm-6 col-xs-6">
              <%= number_to_currency(calculate_sub_total(@order), unit: '$') %>
            </div>
            <div class="left col-lg-6 col-md-6 col-sm-6 col-xs-6">
            Sales Tax:
            </div>
            <div class="right col-lg-6 col-md-6 col-sm-6 col-xs-6">
              <%= number_to_currency(@order.sales_tax, unit: '$') %>
            </div>
            <div class="left col-lg-6 col-md-6 col-sm-6 col-xs-6">
              Shipping:
            </div>
            <div class="right col-lg-6 col-md-6 col-sm-6 col-xs-6">
              <%= number_to_currency(@order.shipping, unit: '$') %>
            </div>
            <div class="left col-lg-6 col-md-6 col-sm-6 col-xs-6">
              <h3>Total:</h3>
            </div>
            <div class="right col-lg-6 col-md-6 col-sm-6 col-xs-6">
              <h3><%= number_to_currency(@order.amount, unit: '$') %></h3>
              <br />
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-md-4 hidden-sm hidden-xs">
        </div>
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
      <div class="col-lg-2 col-md-2 col-sm-1 hidden-xs">
      </div>
      <div class="col-lg-6 col-md-6 col-sm-10 col-xs-12">
        <%= form_for @order, :url => create_payment_order_path(@order), :html => {:id => "payment-form"}  do |f| %>
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" >
          <br />
          <span class="payment-errors"></span>
          <% if @order.errors.any? %><br />
            <div id="error_explanation">
              <h2><%= pluralize(@order.errors.count, "error") %> prohibited this order from submitting:</h2>
              <ul>
              <% @order.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
              </ul>
            </div>
          <% end %>
          <span class="payment-errors"></span>
          <div class="form-row">
            <label>
              <span>Card Number</span>
              <input type="text" size="20" data-stripe="number">
            </label>
          </div>

          <div class="form-row">
            <label>
              <span>Expiration (MM/YY)</span>
              <input type="text" size="2" data-stripe="exp_month">
            </label>
            <span> / </span>
            <input type="text" size="2" data-stripe="exp_year">
          </div>

          <div class="form-row">
            <label>
              <span>CVC</span>
              <input type="text" size="4" data-stripe="cvc">
            </label>
          </div>
          <input type="submit" class="submit" value="Submit Payment">
        </div>
        <%end%>
      </div>
      <div class="col-lg-4 col-md-4 col-sm-1 hidden-xs">
      </div>
    </div>

</div>
<br /><br />
<script type="text/javascript">
  Stripe.setPublishableKey('pk_test_faFoLDlCFHpuTiEHaihzanYo');
</script>
<script>
$(function() {
  console.log('test');
  var $form = $('#payment-form');
  $form.submit(function(event) {
     //Disable the submit button to prevent repeated clicks:
    $form.find('.submit').prop('disabled', true);

    // Request a token from Stripe:
    Stripe.card.createToken($form, stripeResponseHandler);
    console.log($form);
    // Prevent the form from being submitted:
    return false;
  });
});

function stripeResponseHandler(status, response) {
  // Grab the form:
  var $form = $('#payment-form');

  if (response.error) { // Problem!

    // Show the errors on the form:
    $form.find('.payment-errors').text(response.error.message);
    $form.find('.submit').prop('disabled', false); // Re-enable submission

  } else { // Token was created!

    // Get the token ID:
    var token = response.id;

    // Insert the token ID into the form so it gets submitted to the server:
    $form.append($('<input type="hidden" name="stripeToken">').val(token));

    // Submit the form:
    $form.get(0).submit();
  }
};
</script>
