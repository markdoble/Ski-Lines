<%= form_tag "/admin/stripe_accounts/update_banking", :id => "banking-form", :method => :get do %>
<div class="form_heading col-xs-12">
  <div class="banking-errors"></div>
  <br />
  <h4>Bank Account:</h4>
  <br />
</div>
<div class="left_label col-lg-3 col-md-3 col-sm-4 col-xs-12">
  Account Country:
</div>
<div class="col-lg-7 col-md-7 col-sm-8 col-xs-12">
  <%if @fields_needed.include?("external_account")%><span class="fields_needed_class"><%else%><span><%end%>
    <div class="form-row">
      <select data-stripe="country" class="form_field_divs country">
        <option value="" disabled selected>-country-</option>
        <option value="us">United States</option>
        <option value="ca">Canada</option>
      </select>
    </div>
  </span><br />
</div>
<div class="left_label col-lg-3 col-md-3 col-sm-4 col-xs-12">
  Account Currency:
</div>
<div class="col-lg-7 col-md-7 col-sm-8 col-xs-12">
  <%if @fields_needed.include?("external_account")%><span class="fields_needed_class"><%else%><span><%end%>
    <div class="form-row">
      <select data-stripe="currency" class="form_field_divs currency">
        <option value="" disabled selected>-currency-</option>
        <option value="usd">USD</option>
        <option value="cad">CAD</option>
      </select>
    </div>
  </span><br />
</div>
<div class="left_label col-lg-3 col-md-3 col-sm-4 col-xs-12">
  Routing Number:
</div>
<div class="col-lg-7 col-md-7 col-sm-8 col-xs-12">
  <%if @fields_needed.include?("external_account")%><span class="fields_needed_class"><%else%><span><%end%><input type="text" data-stripe="routing-number" class="form-control routing-number"></span><br />
</div>
<div class="left_label col-lg-3 col-md-3 col-sm-4 col-xs-12">
  Account Number:
</div>
<div class="col-lg-7 col-md-7 col-sm-8 col-xs-12">
  <%if @fields_needed.include?("external_account")%><span class="fields_needed_class"><%else%><span><%end%><input type="text" data-stripe="account-number" class="form-control account-number"></span><br />
</div>

<div class="col-xs-12" style="text-align:center">
  <br /><br />
   <input type="submit" class="submit btn btn-primary btn-large" value="Save">
</div>
<% end %>
<script type="text/javascript">
  Stripe.setPublishableKey('pk_test_faFoLDlCFHpuTiEHaihzanYo');
</script>
<script>
$(function() {
  var $form = $('#banking-form');
  $form.submit(function(event) {
     //Disable the submit button to prevent repeated clicks:
    $form.find('.submit').prop('disabled', true);
    // Request a token from Stripe:
    Stripe.bankAccount.createToken($form, stripeResponseHandler);
    // Prevent the form from being submitted:
    return false;
  });
});
function stripeResponseHandler(status, response) {
  // Grab the form:
  var $form = $('#banking-form');
  if (response.error) { // Problem!
    // Show the errors on the form:
    $form.find('.banking-errors').text(response.error.message);
    $form.find('.submit').prop('disabled', false); // Re-enable submission
  } else { // Token was created!
    // Get the token ID:
    var token = response.id;
    // Insert the token ID into the form so it gets submitted to the server:
    $form.append($('<input type="hidden" name="stripeToken">').val(token));
    // Submit the form:
    $form.get(0).submit();
  }
};
</script>
